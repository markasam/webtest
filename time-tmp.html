<!DOCTYPE html>
<html>

<head>
  <title>Flash Math</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <script>
    'use strict';

    // stats  [13/39 | m Incorrect]
    var incorrectCount;
    var correctCount;
    var problemCountGoal;
    var startTime;
    var endTime;
    //var problemCountGoalNext = null;

    // elements
    var answerInput; 
    var startButton;
    var problem;
    var inputCount;


    var answerText; // answer to current problem


    // problem paramiters
    const defaultMin = 2;
    const defaultMax = 9;
    const defaultOps = "x"; // "+-x/";
    const defaultGoal = 36;

    const addChar  = "\u002B";
    const subChar  = "\u2212";
    const multChar = "\u00D7";
    const divChar  = "\u00F7";

    var minValue = defaultMin;
    var maxValue = defaultMax;
    var operators = defaultOps; 

    function menuLinkClick(e) {
      e.preventDefault();
      var goal = inputCount.value;
      var href = e.target.getAttribute("href");
      var searchParams = new URLSearchParams(href);
      searchParams.set("goal", goal);
      window.location.href = `?${searchParams.toString()}`;
    }
    function menuReload() {
      if (!window.location.search) {
        window.location.href = `?goal=${inputCount.value}`;
      } else {
        window.location.reload();
      }

    }

    function onLoad() {

      startButton = document.getElementById('startButton');

      problem = document.getElementById("problem");

      answerInput = document.getElementById('answerInput');
      answerInput.addEventListener('input', anwserInputChanged);
      answerInput.addEventListener("keydown", onKey);
      answerInput.addEventListener('focus', (event) => {
        window.scrollTo(0, 0);
      });

      inputCount = document.getElementById("inputCount");
      inputCount.addEventListener('input', e => {
        var goal = inputCount.value;
        var searchParams = new URLSearchParams(window.location.search);
        searchParams.set("goal", goal);
        var newQStr = searchParams.toString();
        if(history.replaceState) {
            window.history.replaceState(null, null, `?${newQStr}`);
        }
      });
      inputCount.addEventListener('keydown', event => {
        if (event.key === "Enter") {
          menuReload();
        }
      });
      inputCount.addEventListener('focus', e =>{
        e.target.select();
      });

      startButton.onclick = function() {
        document.getElementById('buttonDiv').style.display = "none";
        document.getElementById('answerDiv').style.display = "block";
        
        setParamsFromURL();
        newProblem();       

        incorrectCount = correctCount = endTime = 0;
        startTime = Date.now();
        updateStats();
        addNewScore();
      };

      document.getElementById('menueOpen').onclick = function() {
        loadScoreHistory();
        document.getElementById('menue').style.display = "block";
      };
      document.getElementById('menueClose').onclick = function() {
        document.getElementById('menue').style.display = "none";
        // TODO: implement proper run state
        if (answerInput.offsetParent === null) {
          startButton.focus();
        } else {
          answerInput.focus();
        }
      };

      var links = Array.prototype.slice.call(document.getElementById('settingsLinks').getElementsByTagName('a'));
      for(var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', menuLinkClick);
      }

      setParamsFromURL();
      updateStats();
      loadScoreHistory();
     
      var showMenue = !window.location.search;
      if (showMenue) {
        document.getElementById('menueOpen').onclick();
      } 
      
      document.getElementById('mainContent').style.display ='block';

      if (!showMenue) {
        startButton.focus();
      }

      if (window.location.hash === "#debug") {
        document.getElementById('debugDiv').style.display = "block";
      }
      
    }

    function setParamsFromURL() {
      const paramsString = window.location.search; //'?vrange=2,9&ops=add,mult,sub,div&goal=36';
      let searchParams = new URLSearchParams(paramsString);

      var vrange = searchParams.get("vrange") || `${defaultMin},${defaultMax}`;
      var vrParts = vrange.split(",");
      minValue = parseInt(vrParts[0]); if (isNaN(minValue)) minValue = defaultMin;
      maxValue = parseInt(vrParts[1]); if (isNaN(maxValue)) minValue = defaultMax;
      var ops = searchParams.get("ops"); // "add,mult,sub,div";
      operators = "";
      if (ops) {
        var opsParts = ops.split(",");
        
        for (const e of opsParts) {
          switch (e) {
            case "add":  operators += "+"; break;
            case "mult": operators += "x"; break;
            case "sub":  operators += "-"; break;
            case "div":  operators += "/"; break;
            default: break;
          }
        }
      }
      if (operators === "") {
        operators = defaultOps;
      }
      problemCountGoal = searchParams.get("goal") || defaultGoal;

      document.getElementById('inputCount').value = problemCountGoal;
      document.getElementById('settingsInfo').innerHTML = 
        `( ${getParamsInfoString()} )`;
    }
    function getParamsInfoString(goal=problemCountGoal, ops=operators, min=minValue, max=maxValue) {
      var parts = [];

      //Order like this: ( add sub mult div 2-12 ) 
      // new: ( #36 | add sub mult div | -12 to 12 )
      parts.push(`#${goal} |`);
      if (ops.includes("+")) parts.push(addChar);
      if (ops.includes("-")) parts.push(subChar);
      if (ops.includes("x")) parts.push(multChar);
      if (ops.includes("/")) parts.push(divChar);
      parts.push(`| ${min} to ${max}`);

      return parts.join(" ");
    }

    function updateStats() {
      var stats = document.getElementById('stats');

      if (incorrectCount != 0 && !incorrectCount) {
        stats.innerHTML = "\u00A0"; //`0/${problemCountGoal}`;
        return;
      }

      // stats  [13/39 | Incorrect: n ]
      stats.innerHTML = `${correctCount}/${problemCountGoal} | Incorrect: ${incorrectCount}`;
    }

    function anwserInputChanged() {
      
      if (answerInput.value === answerText) {

        ++correctCount;
        updateStats();

        if (correctCount >= problemCountGoal) {
          endTime = Date.now();
          var seconds = Math.round((endTime-startTime)/1000);
          problem.innerHTML = `Finished in ${seconds}s`;

        document.getElementById('buttonDiv').style.display = "block";
        document.getElementById('answerDiv').style.display = "none";

        updateScore(seconds);

        startButton.focus();

        } else {
          newProblem();
          window.scrollTo(0, 0);
        }
      } else if (!answerText.startsWith(answerInput.value)) {
        
        if (!incorrectFlag) {
          incorrectFlag = true;
          ++incorrectCount;
          updateStats();
        }
        
        answerInput.setCustomValidity("Invalid field.");
      } else {
        answerInput.setCustomValidity("");
      }
    }

    function onKey(event) {
      if (event.key === "Enter") {
        answerInput.value = "";
        anwserInputChanged();
      }
    }


    // Ideas:
    // - Equal/balanced number of operator types, numbers

    var incorrectFlag;
    function newProblem() {
      incorrectFlag = false;

      var newProblemText, lv, rv, op;
      var limit = 30;

      do {

        if (limit-- <= 0) break;

        var lv = getRandomInt(maxValue-minValue+1) + minValue;
        var rv = getRandomInt(maxValue-minValue+1) + minValue;
        var op = operators[getRandomInt(operators.length)];

        if (op === "/") {
          lv = lv * rv;
        } else if (op === "-") {
          lv = lv + rv;
        }

        newProblemText = `${lv} ${operatorToChar(op)} ${rv}`;
      } while (problem.innerHTML === newProblemText || (op === "/" && rv == 0));

      problem.innerHTML = newProblemText;
      answerText = `${getAnswer(op, lv, rv)}`;

      answerInput.value = "";
      answerInput.focus();
    }

    function operatorToChar(op) {
      switch (op) {
        case '+': return addChar;
        case '-': return subChar;
        case 'x': return multChar;
        case '/': return divChar;
        default:
          console.log(`Unkown operator: ${op}.`);
          return "?";
      }
    }

    function getAnswer(op, lv, rv) {
      switch (op) {
        case '+':
          return lv + rv;
        case '-':
          return lv - rv;
        case 'x':
        case '*':
          return lv * rv;
        case '/':
          return lv / rv;
        default:
          console.log(`Unkown operator: ${op}.`);
          return null;
      }
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }


    var scoreHistory = [];
    const scoreHistoryMaxLength = 1000;
    const lsHistoryKey = 'flashmath.time-next.html.history';

    function isSameDay(d0, d1) {
      return d0.getFullYear() === d1.getFullYear() &&
      d0.getMonth() === d1.getMonth() &&
      d0.getDate() === d1.getDate();
    }

    function formatDateTime(date) {
      var hours = date.getHours();
      var mins = date.getMinutes();
      var timeStr = `${hours<10?'0':''}${hours}:${mins<10?'0':''}${mins}`;

      if (isSameDay(date, new Date())) {
        return timeStr;
      } else {
        return `${date.toLocaleDateString()} ${timeStr}`;
      }

    }

    function settingStrToElement(paramsInfoString) {
      var row = document.createElement('tr');
      var tdParams = document.createElement('td');
      tdParams.setAttribute('colspan', '3');
      tdParams.setAttribute('class', 'tdHistorySettingsHeader');
      tdParams.textContent = paramsInfoString;
      row.appendChild(tdParams);
      return row;
    }

    function scoreHistItemToElement(item) {
      var row = document.createElement('tr');
      
      var tdDate = document.createElement('td');
      tdDate.setAttribute('class', 'tdHistoryDate');
      tdDate.textContent = formatDateTime(new Date(item.date));
      row.appendChild(tdDate);

      
      var tdTime = document.createElement('td');
      tdTime.setAttribute('class', 'tdHistoryTime');
      tdTime.textContent = item.isCompleate ? `${item.time}s` : 'x';
      row.appendChild(tdTime);

      // if (item.isCompleate) {
        var tdIncorrect = document.createElement('td');
        tdIncorrect.setAttribute('class', 'tdHistoryIncorrect');
        tdIncorrect.textContent = item.incorrectCount > 0 ? `-${item.incorrectCount}` : '';
        row.appendChild(tdIncorrect);
      // }

      return row;
    }

    function loadScoreHistory(limit=50) {
      const scorsStr = window.localStorage.getItem(lsHistoryKey);
      if (scorsStr) {
        scoreHistory = JSON.parse(scorsStr);
      }

      document.getElementById('historyHeader').style.display = 
        scoreHistory.length > 0 ? "block" : "none";

      document.getElementById('historyShowAllLink').style.display = 
        scoreHistory.length > limit ? "block" : "none";

      var lastSettingsStr = "";
      var table = document.getElementById('historyTable');
      table.innerHTML = '';
      for (var i = scoreHistory.length - 1; i >= 0; --i) {
        var item = scoreHistory[i];
        var curSettingsStr = getParamsInfoString(item.count, item.ops, item.minValue, item.maxValue)
        if (lastSettingsStr !== curSettingsStr) {
          lastSettingsStr = curSettingsStr;
          table.appendChild(settingStrToElement(curSettingsStr));
        }
        table.appendChild(scoreHistItemToElement(item));

        if (--limit <= 0)
          break;
      }
    }

    function showAllHistory() {
      loadScoreHistory(scoreHistoryMaxLength);
      return false;
    }



    function updateScore(seconds) {
      const item = {
        date: Date.now(),
        count: problemCountGoal,
        ops: operators,
        minValue: minValue,
        maxValue: maxValue,
        incorrectCount: incorrectCount,
        time: seconds,
        isCompleate: true
      }
      scoreHistory[scoreHistory.length - 1] = item;
      storeScoreHistory();
    }

    function addNewScore() {
      const item = {
        date: Date.now(),
        count: problemCountGoal,
        ops: operators,
        minValue: minValue,
        maxValue: maxValue,
        //incorrectCount: incorrectCount,
        //time: seconds,
        isCompleate: false
      }
      scoreHistory.push(item);
      // var table = document.getElementById('historyTable');
      // table.prepend(scoreHistItemToElement(item));
      storeScoreHistory();
    }
    function storeScoreHistory() {
      if (scoreHistory.length > scoreHistoryMaxLength) {
        scoreHistory = scoreHistory.slice(-scoreHistoryMaxLength);
      }
      window.localStorage.setItem(lsHistoryKey, JSON.stringify(scoreHistory));
    }

     function test_saveRandomScores() {
      for (var i = 0; i < 1000; ++i) {
        scoreHistory.push({
          date: Date.now(),
          count: problemCountGoal,
          ops: operators,
          minValue: minValue,
          maxValue: maxValue,
          incorrectCount: incorrectCount,
          time: getRandomInt(255),
          isCompleate: true
        });
      }
      storeScoreHistory();
    }
    function test_clearLocalStore() {
      window.localStorage.clear();
    }

  </script>

  <style>

      #problem {
        margin-top: 1.3em;
        margin-bottom: 1.3em;
        vertical-align: middle;
        text-align: center;
        font-size: 250%
      }

      #answerInput {
        text-align: center;
        width: 5em;
        font-size: 200%;
      }

      #settingsInfo {
        font-size: 125%;
      }

      #startButton {
        font-size: 250%;
        padding: 0.2em 1em 0.2em 1em;
      }

      #buttonDiv {
        text-align: center;
      }

      #answerDiv {
        text-align: center;
        display: none;
      }

      #answerInput::-webkit-outer-spin-button,
      #answerInput::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0; 
      }

      #answerInput[type=number] {
          -moz-appearance:textfield; /* Firefox */
      }

      #answerInput:invalid {
        color: red;
      }

      #answerInput:valid {
        color: black;
      }

      #mainContent {
        display: none;
      }

      #menue {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: white;
        display: none;
      }


      #menueHeader {
        margin: 8px;
      }



      #menueContent {
        display:table;
        margin-top: 2em;
        margin-left: auto;
        margin-right: auto;
        font-size: 115%;
      }

      
      #menueContent ul {
        list-style-type: none;
        padding: 0;
      }
      #menueContent li {
        margin: 0em 0em 0.6em 0em ;
      }
      #menueContent a {
        margin: 0em 0.25em 0em 0.25em ;
      }
      #inputCount {
        text-align: center;
        margin: 0em 0.25em 0em 0.25em ;
        width: 3em;
        font-size: 105%;
      }
      #menuReload {
        font-size: 105%;
      }


      #menueContent a:link {
        color: black;
      }

      #menueContent a:visited {
        color: black;
      }

      #stats {
        padding: 0 6px;
        font-size: 125%;
      }

      #menueOpen, #menueClose {
        padding: 0 0.25em;
        font-size: 140%;
      }

      #menueOpen:after {
        content: '\2807';
      }
      #menueClose:after {
        content: '\2716';
      }

/*      #historyDiv {
         display: table;
         margin: 0 auto;
      }*/
      #historyHeader {
        display: none;
      }

      .tdHistorySettingsHeader {
        padding-top: 5px;
        white-space: nowrap;
      }
      .tdHistoryDate {
        color: darkgray;
       padding-left: 7px; 
      }
      .tdHistoryTime {
        padding-left: 8px;
      }

      #debugDiv {
        display: none;
      }

    </style>
</head>

<body onload="onLoad();">

  <div id="mainContent">
    <div id="header">
      <span id="stats"></span>
      <span id="menueOpen" style="float: right;"></span>
    </div>
    <p id="problem"></p>

    <div id="buttonDiv">
      <p id="settingsInfo"></p>
      <button id="startButton">Start</button>
    </div>

    <div id="answerDiv">
      <input id="answerInput" placeholder="Answer" type="number" inputmode="numeric" pattern="\d*" />
    </div>

    <div id="debugDiv">
      <button onclick="test_saveRandomScores();">Gen Test Data</button>
      <button onclick="test_clearLocalStore();">Clear Local Store</button>
    </div>
  </div>

  <div id="menue">
    <div id="menueHeader">
      <span></span>
      <span id="menueClose" style="float: right;"></span>
    </div>
  
    <div id="menueContent">
      <ul id="settingsLinks">
        <li>
          Problems: <input id="inputCount" type="number" min="1" inputmode="numeric" pattern="\d*" />
          <button id="menuReload" onclick="menuReload();">Reload</button>
        </li>
        <li>Addition:
          <a href="?vrange=2,12&ops=add&goal=36">2-12</a> |
          <a href="?vrange=2,24&ops=add&goal=36">2-24</a>
        </li>
        <li>Subtraction:
          <a href="?vrange=2,12&ops=sub&goal=36">2-12</a> |
          <a href="?vrange=2,24&ops=sub&goal=36">2-24</a>
        </li>
        <li>Multiplication:
          <a href="?vrange=2,9&ops=mult&goal=36">2-9</a> |
          <a href="?vrange=6,9&ops=mult&goal=36">6-9</a> |
          <a href="?vrange=2,12&ops=mult&goal=36">2-12</a>
        </li>
        <li>Division:
          <a href="?vrange=2,9&ops=div&goal=36">2-9</a> |
          <a href="?vrange=6,9&ops=div&goal=36">6-9</a> |
          <a href="?vrange=2,12&ops=div&goal=36">2-12</a>
        </li>
        <li>All:
          <a href="?vrange=2,9&ops=add,sub,mult,div&goal=36">2-9</a> |
          <a href="?vrange=6,9&ops=add,sub,mult,div&goal=36">6-9</a> |
          <a href="?vrange=2,12&ops=add,sub,mult,div&goal=36">2-12</a>
        </li>
        <li>Add and Sub:
          <a href="?vrange=2,24&ops=add,sub&goal=36">2-24</a> |
          <a href="?vrange=2,36&ops=add,sub&goal=36">2-36</a>
        </li>
        <li>Mult and Div:
          <a href="?vrange=2,9&ops=mult,div&goal=36">2-9</a> |
          <a href="?vrange=2,12&ops=mult,div&goal=36">2-12</a>
        </li>
      </ul>
  
      <div id="historyDiv">
        <h4 id="historyHeader">History</h4>
        <table id="historyTable">
        </table>
        <a id="historyShowAllLink" href="" onclick="return showAllHistory();">Show all</a>
      </div>
  
    </div>

  </div>

</body>

</html>
